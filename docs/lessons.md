# Lessons - 過去の失敗と学び

## 記録ルール

- バグを解決したら、ここにパターンと対策を追記する
- 設計上の判断ミスや整合性の注意点も記録する
- 同じ失敗を繰り返さないための知見をまとめる

## 2026-02-22 表示文言の取りこぼし防止

- パターン: 演出用ビューの文言実装で、依頼された固定文言の一部（大会名）を反映し漏らす。
- 対策: 文言を含む要件では「表示テキストの完全一致チェック」を先にテストへ追加し、改行単位で必要行を網羅する。

## 2026-02-24 演出要件の継続性確認不足

- パターン: 押下演出を「一度光る」で実装したが、運用要件は「点滅を継続」であった。
- 対策: 演出仕様では「単発か継続か」「解除トリガーは何か」を実装前チェックリストに明示し、CSSアニメーションの `iteration-count` を要件に合わせて確認する。

## 2026-02-24 演出の補間方式確認不足

- パターン: 点滅を実装する際に `step-end` を選び、明るさ変化が不連続になった。
- 対策: 視覚演出で「連続的に変化」と指定された場合、`ease-in-out` などの補間を使い、`50%` を頂点にした往復キーフレームで実装する。

## 2026-02-25 型実装方式の指定反映不足

- パターン: branded type 化の検討時に、ユーザが指定した実装方式（`unique symbol`）を先に固定せず一般論で進めてしまう。
- 対策: 型設計の依頼では、実装方式の指定（例: `unique symbol`、opaque type）を最初にチェックリスト化し、型定義ファイルを作る前に必ず満たすことを確認する。

## 2026-02-25 実行時ガードの意図共有不足

- パターン: 型注釈が厳密な箇所でも、外部境界での実行時ガードの理由コメントがなく、レビュー時に意図が伝わりにくい。
- 対策: `CustomEvent` など外部入力境界で行うバリデーションには、型だけでは防げない理由を1行コメントで明示する。

## 2026-02-25 コメント言語の統一不足

- パターン: 日本語運用のプロジェクトで、コードコメントを英語で追加してしまい、レビュー基準と不整合になる。
- 対策: 新規コメント追加時は既存運用言語（本プロジェクトでは日本語）を確認し、明示要望がある場合は必ずその言語で記述する。

## 2026-02-25 テスト後処理の分散管理

- パターン: 各 `it` で `teardownControllerTest` を手動呼び出しすると、将来のテスト追加時に呼び忘れが混入しやすい。
- 対策: Stimulus コントローラテストでは `afterEach` に teardown を集約し、セットアップ時に `application` を共有変数へ格納して一元クリーンアップする。

## 2026-02-25 Turbo差し替え境界の検証不足

- パターン: 責務分離時に単体テスト中心で満足し、`turbo:before-stream-render` の実処理順（DOM更新→独自 action）を通す結合検証を入れ漏らす。
- 対策: Turbo連携を含む変更では、`detail.render` 実行まで含めた統合テストを必ず1本追加し、差し替え後DOMへの追従を確認する。

## 2026-02-25 no-op方針の過剰適用

- パターン: target 欠落時の安全策として全面 no-op に寄せ、ユーザ向けエラー表示（`mainError`）の欠落検知まで黙殺してしまう。
- 対策: UIの最後の砦となる要素は no-op ではなく `console.error` を必須化し、テストでログ出力を検証する。

## 2026-02-25 非同期統合テストの固定sleep依存

- パターン: Turbo連携の統合テストで `setTimeout` 固定待機を使うと、実行環境差で flaky になりやすい。
- 対策: 統合テストの完了待機は `waitForCondition` などの状態待ちに統一し、固定sleepを禁止する。

## 2026-02-25 空判定の曖昧さ

- パターン: エラーメッセージの「空」判定を曖昧にすると、空白のみの値で表示分岐が不安定になる。
- 対策: 空判定は `trim() === ""` で固定し、空白文字ケースをテストに追加して仕様を固定する。

## 2026-02-25 境界値テストの原因分離不足

- パターン: `questionId` の不正検知テストで「属性欠落」と「0指定」を同じ失敗ケースとして扱い、原因の違いを固定できない。
- 対策: 外部境界の fail-fast テストは「欠落」と「不正値」を必ず別テストに分離し、欠落時は属性自体を除去した入力で検証する。

## 2026-02-25 API境界の型回帰検知不足

- パターン: 型導入後にAPIペイロードの実際のJSON型（number/string）を固定しないと、将来の `String()` 変換回帰を見逃す。
- 対策: APIテストでペイロード値の `typeof` まで検証し、`QuestionId` 送信時は `question_id` が number であることを明示的に固定する。

## 2026-02-25 純粋関数テストの前提条件不足

- パターン: 抽出した純粋関数のテストで、分岐に必要な前提属性（例: `action="update-question"`）を明示せず、意図した経路を検証できない。
- 対策: 純粋関数の単体テストでは「対象分岐へ到達する前提」を必ずArrangeで固定し、間接検証ではなく直接検証を1本以上追加する。

## 2026-02-25 fire-and-forget 検証時のハング要因見落とし

- パターン: `void` で非同期処理を投げるテストで、待機対象の別非同期（`await` されるAPI）まで未解決にしてしまい、テストがハングしうる。
- 対策: fire-and-forget テストでは「待機される非同期」は `mockResolvedValue` で即時解決に固定し、未解決Promiseを使う場合は `finally` で `resolve` して後始末を保証する。
